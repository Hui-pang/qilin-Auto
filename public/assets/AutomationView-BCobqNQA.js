import{_ as fe,r as v,l as ce,m as ye,c as z,j as m,a as t,w as a,n as F,p as we,i as ke,q as _e,E as Ce,s as Ve,k as s,u as be,o as y,t as Ie,v as h,x as he,y as Te,h as r,z as xe,A as Pe,B as $e,C as V,b as De,e as Ee,f as Ue,D as Ae,F as Se,G as Me,H as Le,I as ze,J as B}from"./index-CWseees8.js";/* empty css              */import{a as f}from"./index-D4aPKAAE.js";/* empty css                 *//* empty css                *//* empty css               */const Fe={class:"automation-container"},Be={class:"title-container"},Re={class:"title-buttons"},He={class:"card-actions"},Ne={style:{display:"flex",gap:"8px","justify-content":"flex-start"}},je={key:1,class:"card-message"},qe={class:"dialog-footer"},Oe={class:"dialog-footer"},Ge={class:"card-actions"},Je={style:{display:"flex",gap:"8px","justify-content":"flex-start"}},Ke={key:1,class:"card-message"},Qe={class:"dialog-footer"},We={class:"dialog-footer"},Xe={class:"dialog-footer"},Ye={__name:"AutomationView",setup(Ze){const G=be(),{isDark:J,toggleTheme:K}=we(),$=v(!1),p=v([]),T=v({logPath:""}),D=v(!1),_=v({id:"",logPath:""}),E=v(!1),x=v(""),U=v(null),w=v(null),c=v(null);ce(()=>{c.value&&(clearInterval(c.value),c.value=null)});const R=async()=>{if(U.value)try{const o=await f.get(`/api/log-monitor/log?path=${encodeURIComponent(U.value.logPath)}`);o.data!==x.value&&(x.value=o.data,await B(),w.value&&(w.value.scrollTop=w.value.scrollHeight))}catch(o){console.error("获取日志内容失败:",o)}},Q=async o=>{var e,i;U.value=o;try{const n=await f.get(`/api/log-monitor/log?path=${encodeURIComponent(o.logPath)}`);x.value=n.data,E.value=!0,c.value=setInterval(R,2e3),await B(),w.value&&(w.value.scrollTop=w.value.scrollHeight)}catch(n){s.error(((i=(e=n.response)==null?void 0:e.data)==null?void 0:i.message)||"获取日志内容失败"),console.error("获取日志内容失败:",n)}},W=async o=>{var e,i;try{let n="";if(o.program==="alist"?n=`/app/server/logs/alist-refresh-${o.portId}.log`:o.program==="alist-strm"&&(n="/app/server/logs/alist-strm-api.log"),!n){s.warning("该任务类型暂不支持查看日志");return}U.value={logPath:n};const b=await f.get(`/api/log-monitor/log?path=${encodeURIComponent(n)}`);x.value=b.data,E.value=!0,c.value=setInterval(R,2e3),await B(),w.value&&(w.value.scrollTop=w.value.scrollHeight)}catch(n){s.error(((i=(e=n.response)==null?void 0:e.data)==null?void 0:i.message)||"获取日志内容失败"),console.error("获取日志内容失败:",n)}},X=async()=>{try{const o=await f.get("/api/log-monitor");p.value=o.data}catch(o){s.error("获取监控配置失败"),console.error("获取监控配置失败:",o)}},Y=async()=>{if(!T.value.logPath){s.warning("请输入日志监控目录路径");return}if(p.value.length>0){s.warning("已存在监控配置，不能创建更多");return}try{const o=await f.post("/api/log-monitor",{logPath:T.value.logPath});p.value.push(o.data),$.value=!1,T.value.logPath="",s.success("创建成功")}catch(o){s.error("创建监控配置失败"),console.error("创建监控配置失败:",o)}},Z=async o=>{const e=p.value[o],i=e.status==="active"?"inactive":"active";try{await f.put(`/api/log-monitor/${e.id}/status`,{status:i}),e.status=i}catch(n){s.error("更新状态失败"),console.error("更新状态失败:",n)}},ee=async o=>{const e=p.value[o];try{await f.delete(`/api/log-monitor/${e.id}`),p.value.splice(o,1),s.success("删除成功")}catch(i){s.error("删除失败"),console.error("删除失败:",i)}},le=async()=>{try{const o=await f.get("/api/automation");g.value=o.data}catch(o){s.error("获取自动化任务列表失败"),console.error("获取自动化任务列表失败:",o)}};ye(()=>{X(),le()});const te=()=>{localStorage.removeItem("token"),localStorage.removeItem("expiresAt"),G.push("/login")},ae=()=>{if(p.value.length>0){s.warning("已存在监控配置，不能创建更多");return}$.value=!0},oe=o=>{_.value={id:o.id,logPath:o.logPath},D.value=!0},ne=async()=>{if(!_.value.logPath){s.warning("请输入日志监控目录路径");return}try{const o=await f.put(`/api/log-monitor/${_.value.id}`,{logPath:_.value.logPath}),e=p.value.findIndex(i=>i.id===_.value.id);e!==-1&&(p.value[e]=o.data),D.value=!1,s.success("更新成功")}catch(o){s.error("更新监控配置失败"),console.error("更新监控配置失败:",o)}},g=v([]),A=v(!1),u=v({program:"",configId:"",monitorPath:"",delayTime:0}),se=[{label:"Alist-strm",value:"alist-strm"},{label:"TaoSync",value:"taosync"},{label:"Alist目录刷新",value:"alist"}],re=()=>{if(p.value.length===0){s.warning("请先创建日志监控配置");return}A.value=!0},ie=async()=>{if(!u.value.program){s.warning("请选择自动化程序");return}if(u.value.program==="alist"){if(!u.value.monitorPath){s.warning("请输入监控路径");return}}else if(!u.value.configId){s.warning("请输入配置ID");return}if(u.value.program!=="alist"&&g.value.find(e=>e.program===u.value.program)){s.warning(`请删除原有${u.value.program}自动化任务，再操作`);return}try{let o={...u.value,createTime:new Date().toISOString(),status:"inactive"};if(u.value.program==="alist"){const i=g.value.filter(b=>b.program==="alist"),n=i.length>0?Math.max(...i.map(b=>b.portId||0)):0;o.portId=n+1}const e=await f.post("/api/automation",o);g.value.push(e.data),A.value=!1,u.value={program:"",configId:"",monitorPath:"",delayTime:0},s.success("创建成功")}catch(o){s.error("创建自动化任务失败"),console.error("创建自动化任务失败:",o)}},H=async o=>{try{await f.delete(`/api/automation/${o}`),g.value=g.value.filter(e=>e.id!==o),s.success("删除成功")}catch(e){s.error("删除失败"),console.error("删除失败:",e)}},ue=async o=>{const e=g.value[o],i=e.status==="active"?"inactive":"active";try{await f.put(`/api/automation/${e.id}/status`,{status:i}),e.status=i,s.success(`${i==="active"?"启动":"停止"}成功`)}catch(n){s.error("更新状态失败"),console.error("更新状态失败:",n)}},S=v(!1),d=v({id:null,program:"",configId:"",monitorPath:"",delayTime:0,portId:null}),de=o=>{d.value={...o},S.value=!0},me=async()=>{if(d.value.program==="alist"){if(!d.value.monitorPath){s.warning("请输入监控路径");return}}else{if(!d.value.configId){s.warning("请输入配置ID");return}if(g.value.find(e=>e.program===d.value.program&&e.id!==d.value.id)){s.warning(`已存在${d.value.program}自动化任务`);return}}try{await f.put(`/api/automation/${d.value.id}`,d.value);const o=g.value.findIndex(e=>e.id===d.value.id);o!==-1&&(g.value[o]={...d.value}),S.value=!1,s.success("更新成功")}catch(o){s.error("更新自动化任务失败"),console.error("更新自动化任务失败:",o)}},ve=()=>{c.value&&(clearInterval(c.value),c.value=null),x.value="",U.value=null};return(o,e)=>{const i=Ie,n=ke,b=_e,k=Pe,N=$e,j=xe,q=Ce,I=Ue,C=Ee,L=De,M=Ve,pe=Le,ge=Ae,O=ze;return y(),z("div",Fe,[m("div",Be,[e[20]||(e[20]=m("h1",{class:"section-title"},"创建自动化",-1)),m("div",Re,[t(n,{type:"info",circle:"",onClick:F(K)},{default:a(()=>[t(i,null,{default:a(()=>[(y(),h(he(F(J)?"Sunny":"Moon")))]),_:1})]),_:1},8,["onClick"]),t(n,{type:"danger",circle:"",onClick:te},{default:a(()=>[t(i,null,{default:a(()=>[t(F(Te))]),_:1})]),_:1})])]),t(b),e[41]||(e[41]=m("h2",{class:"subsection-title"},"CloudSaver日志监控配置",-1)),t(q,{class:"content-card"},{default:a(()=>[m("div",He,[t(n,{type:"primary",onClick:ae},{default:a(()=>e[21]||(e[21]=[r("创建")])),_:1}),t(n,{type:"danger",disabled:p.value.length===0,onClick:e[0]||(e[0]=l=>ee(0))},{default:a(()=>e[22]||(e[22]=[r("删除")])),_:1},8,["disabled"])]),p.value.length>0?(y(),h(j,{key:0,data:p.value,style:{width:"100%"}},{default:a(()=>[t(k,{prop:"createTime",label:"创建时间",width:"180"}),t(k,{prop:"logPath",label:"日志监控路径"}),t(k,{prop:"status",label:"状态",width:"100"},{default:a(l=>[t(N,{type:l.row.status==="active"?"success":"info"},{default:a(()=>[r(V(l.row.status==="active"?"运行中":"已停止"),1)]),_:2},1032,["type"])]),_:1}),t(k,{label:"操作",width:"280"},{default:a(l=>[m("div",Ne,[t(n,{size:"small",type:l.row.status==="active"?"warning":"success",onClick:P=>Z(l.$index)},{default:a(()=>[r(V(l.row.status==="active"?"停止":"启动"),1)]),_:2},1032,["type","onClick"]),t(n,{size:"small",type:"primary",onClick:P=>oe(l.row)},{default:a(()=>e[23]||(e[23]=[r(" 编辑 ")])),_:2},1032,["onClick"]),t(n,{size:"small",type:"info",onClick:P=>Q(l.row)},{default:a(()=>e[24]||(e[24]=[r(" 日志 ")])),_:2},1032,["onClick"])])]),_:1})]),_:1},8,["data"])):(y(),z("div",je,e[25]||(e[25]=[m("span",{class:"message-text"},"暂无监控配置，请点击创建按钮添加",-1)])))]),_:1}),t(M,{modelValue:$.value,"onUpdate:modelValue":e[3]||(e[3]=l=>$.value=l),title:"创建日志监控配置",width:"30%","close-on-click-modal":!1},{footer:a(()=>[m("span",qe,[t(n,{onClick:e[2]||(e[2]=l=>$.value=!1)},{default:a(()=>e[26]||(e[26]=[r("取消")])),_:1}),t(n,{type:"primary",onClick:Y},{default:a(()=>e[27]||(e[27]=[r("确定")])),_:1})])]),default:a(()=>[t(L,{model:T.value,"label-width":"120px"},{default:a(()=>[t(C,{label:"日志监控目录"},{default:a(()=>[t(I,{modelValue:T.value.logPath,"onUpdate:modelValue":e[1]||(e[1]=l=>T.value.logPath=l),placeholder:"请输入日志监控目录路径"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(M,{modelValue:D.value,"onUpdate:modelValue":e[6]||(e[6]=l=>D.value=l),title:"编辑日志监控配置",width:"30%","close-on-click-modal":!1},{footer:a(()=>[m("span",Oe,[t(n,{onClick:e[5]||(e[5]=l=>D.value=!1)},{default:a(()=>e[28]||(e[28]=[r("取消")])),_:1}),t(n,{type:"primary",onClick:ne},{default:a(()=>e[29]||(e[29]=[r("确定")])),_:1})])]),default:a(()=>[t(L,{model:_.value,"label-width":"120px"},{default:a(()=>[t(C,{label:"日志监控目录"},{default:a(()=>[t(I,{modelValue:_.value.logPath,"onUpdate:modelValue":e[4]||(e[4]=l=>_.value.logPath=l),placeholder:"请输入日志监控目录路径"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),e[42]||(e[42]=m("h2",{class:"subsection-title"},"自动化列表",-1)),t(q,{class:"content-card"},{default:a(()=>[m("div",Ge,[t(n,{type:"success",onClick:re},{default:a(()=>e[30]||(e[30]=[r("新增")])),_:1}),t(n,{type:"danger",disabled:g.value.length===0,onClick:H},{default:a(()=>e[31]||(e[31]=[r("删除")])),_:1},8,["disabled"])]),g.value.length>0?(y(),h(j,{key:0,data:g.value,style:{width:"100%"}},{default:a(()=>[t(k,{prop:"createTime",label:"创建时间",width:"180"},{default:a(l=>[r(V(new Date(l.row.createTime).toLocaleString()),1)]),_:1}),t(k,{prop:"program",label:"自动化程序"},{default:a(l=>[r(V(l.row.program==="alist"?"Alist目录刷新":l.row.program),1)]),_:1}),t(k,{label:"配置ID或目录"},{default:a(l=>[r(V(l.row.program==="alist"?l.row.monitorPath:l.row.configId),1)]),_:1}),t(k,{prop:"delayTime",label:"延迟时间(秒)",width:"120"}),t(k,{prop:"status",label:"状态",width:"100"},{default:a(l=>[t(N,{type:l.row.status==="active"?"success":"info"},{default:a(()=>[r(V(l.row.status==="active"?"运行中":"已停止"),1)]),_:2},1032,["type"])]),_:1}),t(k,{label:"操作",width:"280"},{default:a(l=>[m("div",Je,[t(n,{size:"small",type:l.row.status==="active"?"warning":"success",onClick:P=>ue(l.$index)},{default:a(()=>[r(V(l.row.status==="active"?"停止":"启动"),1)]),_:2},1032,["type","onClick"]),t(n,{size:"small",type:"primary",onClick:P=>de(l.row)},{default:a(()=>e[32]||(e[32]=[r(" 编辑 ")])),_:2},1032,["onClick"]),t(n,{size:"small",type:"danger",onClick:P=>H(l.row.id)},{default:a(()=>e[33]||(e[33]=[r(" 删除 ")])),_:2},1032,["onClick"]),t(n,{size:"small",type:"info",onClick:P=>W(l.row)},{default:a(()=>e[34]||(e[34]=[r(" 日志 ")])),_:2},1032,["onClick"])])]),_:1})]),_:1},8,["data"])):(y(),z("div",Ke,e[35]||(e[35]=[m("span",{class:"message-text"},"暂无自动化任务，请点击新增按钮添加",-1)])))]),_:1}),t(M,{modelValue:A.value,"onUpdate:modelValue":e[12]||(e[12]=l=>A.value=l),title:"创建自动化任务",width:"30%","close-on-click-modal":!1},{footer:a(()=>[m("span",Qe,[t(n,{onClick:e[11]||(e[11]=l=>A.value=!1)},{default:a(()=>e[36]||(e[36]=[r("取消")])),_:1}),t(n,{type:"primary",onClick:ie},{default:a(()=>e[37]||(e[37]=[r("确定")])),_:1})])]),default:a(()=>[t(L,{model:u.value,"label-width":"120px"},{default:a(()=>[t(C,{label:"自动化程序"},{default:a(()=>[t(ge,{modelValue:u.value.program,"onUpdate:modelValue":e[7]||(e[7]=l=>u.value.program=l),placeholder:"请选择自动化程序"},{default:a(()=>[(y(),z(Se,null,Me(se,l=>t(pe,{key:l.value,label:l.label,value:l.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),t(C,{label:u.value.program==="alist"?"监控路径":"配置ID"},{default:a(()=>[u.value.program==="alist"?(y(),h(I,{key:0,modelValue:u.value.monitorPath,"onUpdate:modelValue":e[8]||(e[8]=l=>u.value.monitorPath=l),placeholder:"请输入需要监控的文件夹路径"},null,8,["modelValue"])):(y(),h(I,{key:1,modelValue:u.value.configId,"onUpdate:modelValue":e[9]||(e[9]=l=>u.value.configId=l),placeholder:"请输入配置ID,如1或者1,2"},null,8,["modelValue"]))]),_:1},8,["label"]),t(C,{label:"延迟时间(秒)"},{default:a(()=>[t(O,{modelValue:u.value.delayTime,"onUpdate:modelValue":e[10]||(e[10]=l=>u.value.delayTime=l),min:0,step:1},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(M,{modelValue:S.value,"onUpdate:modelValue":e[17]||(e[17]=l=>S.value=l),title:"编辑自动化任务",width:"30%","close-on-click-modal":!1},{footer:a(()=>[m("span",We,[t(n,{onClick:e[16]||(e[16]=l=>S.value=!1)},{default:a(()=>e[38]||(e[38]=[r("取消")])),_:1}),t(n,{type:"primary",onClick:me},{default:a(()=>e[39]||(e[39]=[r("确定")])),_:1})])]),default:a(()=>[t(L,{model:d.value,"label-width":"120px"},{default:a(()=>[t(C,{label:"自动化程序"},{default:a(()=>[t(I,{value:d.value.program,disabled:""},null,8,["value"])]),_:1}),t(C,{label:d.value.program==="alist"?"监控路径":"配置ID"},{default:a(()=>[d.value.program==="alist"?(y(),h(I,{key:0,modelValue:d.value.monitorPath,"onUpdate:modelValue":e[13]||(e[13]=l=>d.value.monitorPath=l),placeholder:"请输入需要监控的文件夹路径"},null,8,["modelValue"])):(y(),h(I,{key:1,modelValue:d.value.configId,"onUpdate:modelValue":e[14]||(e[14]=l=>d.value.configId=l),placeholder:"请输入配置ID,如1或者1,2"},null,8,["modelValue"]))]),_:1},8,["label"]),t(C,{label:"延迟时间(秒)"},{default:a(()=>[t(O,{modelValue:d.value.delayTime,"onUpdate:modelValue":e[15]||(e[15]=l=>d.value.delayTime=l),min:0,step:1},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(M,{modelValue:E.value,"onUpdate:modelValue":e[19]||(e[19]=l=>E.value=l),title:"日志内容",width:"60%","close-on-click-modal":!1,onClosed:ve},{footer:a(()=>[m("span",Xe,[t(n,{onClick:e[18]||(e[18]=()=>{E.value=!1,c.value.value&&(o.clearInterval(c.value.value),c.value.value=null)})},{default:a(()=>e[40]||(e[40]=[r("关闭")])),_:1})])]),default:a(()=>[m("div",{class:"log-content",ref_key:"logContentRef",ref:w},[m("pre",null,V(x.value),1)],512)]),_:1},8,["modelValue"])])}}},sl=fe(Ye,[["__scopeId","data-v-7cd83a28"]]);export{sl as default};
